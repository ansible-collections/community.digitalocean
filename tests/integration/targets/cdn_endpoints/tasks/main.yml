---
- block:

    - name: Ensure API key is provided
      ansible.builtin.fail:
        msg: do_api_key should be defined in tests/integration/integration_config.yml
      when:
        - do_api_key is not defined
        - do_api_key | length == 0

    - name: Create CDN endpoint
      community.digitalocean.cdn_endpoints:
        token: "{{ do_api_key }}"
        state: present
        origin: "{{ origin }}"
        ttl: 3600
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " created"
          - result.endpoint is defined
          - result.endpoint.created_at is defined
          - result.endpoint.endpoint == endpoint
          - result.endpoint.id is defined
          - result.endpoint.origin is defined
          - result.endpoint.origin == origin
          - result.endpoint.ttl is defined

    - name: Pause for 10 seconds
      ansible.builtin.pause:
        seconds: 10

    - name: Update CDN endpoint
      community.digitalocean.cdn_endpoints:
        token: "{{ do_api_key }}"
        state: present
        origin: "{{ origin }}"
        ttl: 600
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " updated"
          - result.endpoint is defined
          - result.endpoint.created_at is defined
          - result.endpoint.endpoint == endpoint
          - result.endpoint.id is defined
          - result.endpoint.origin is defined
          - result.endpoint.origin == origin
          - result.endpoint.ttl is defined

    - name: Pause for 10 seconds
      ansible.builtin.pause:
        seconds: 10

    - name: Update CDN endpoint (no change)
      community.digitalocean.cdn_endpoints:
        token: "{{ do_api_key }}"
        state: present
        origin: "{{ origin }}"
        ttl: 600
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - not result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " exists"
          - result.endpoint is defined
          - result.endpoint.id is defined
          - result.endpoint.origin is defined
          - result.endpoint.origin == origin
          - result.endpoint.ttl is defined

    - name: Pause for 10 seconds
      ansible.builtin.pause:
        seconds: 10

    - name: Delete CDN endpoint
      community.digitalocean.cdn_endpoints:
        token: "{{ do_api_key }}"
        state: absent
        origin: "{{ origin }}"
      register: result

    - name: Verify CDN endpoint
      ansible.builtin.assert:
        that:
          - result.changed
          - result.msg is string
          - result.msg == "CDN endpoint " ~ origin ~ " deleted"
          - result.endpoint is defined

  always:

    - name: Delete CDN endpoint
      community.digitalocean.cdn_endpoints:
        token: "{{ do_api_key }}"
        state: absent
        origin: "{{ origin }}"
      ignore_errors: true
