---

- name: Ensure API key is provided
  ansible.builtin.fail:
    msg: do_api_key should be defined in tests/integration/integration_config.yml
  when:
    - do_api_key is not defined
    - do_api_key | length == 0

- name: Ensure the Droplet is absent
  community.digitalocean.digital_ocean_droplet:
    oauth_token: "{{ do_api_key }}"
    state: absent
    name: "{{ droplet_name }}"
    unique_name: true
    region: "{{ do_region }}"
    image: "{{ droplet_image }}"
    size: "{{ droplet_size }}"
  register: result

- name: Verify previous play did not require changes
  ansible.builtin.assert:
    that:
      - not result.changed

- name: Ensure the Droplet is present
  community.digitalocean.digital_ocean_droplet:
    oauth_token: "{{ do_api_key }}"
    state: present
    name: "{{ droplet_name }}"
    unique_name: true
    region: "{{ do_region }}"
    image: "{{ droplet_image }}"
    size: "{{ droplet_size }}"
    wait_timeout: 500
  register: result

- name: Verify previous play did require changes
  ansible.builtin.assert:
    that:
      - result.changed

- name: Give the cloud a few minutes to settle
  ansible.builtin.pause:
    minutes: 3

- name: Ensure the Droplet is absent
  community.digitalocean.digital_ocean_droplet:
    oauth_token: "{{ do_api_key }}"
    state: absent
    name: "{{ droplet_name }}"
    unique_name: true
    region: "{{ do_region }}"
    image: "{{ droplet_image }}"
    size: "{{ droplet_size }}"
  register: result

- name: Verify previous play did require changes
  ansible.builtin.assert:
    that:
      - result.changed
