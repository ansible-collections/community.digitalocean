---

- name: Ensure API key is provided
  ansible.builtin.fail:
    msg: do_api_key should be defined in tests/integration/integration_config.yml
  when:
    - do_api_key is not defined
    - do_api_key | length == 0

- name: Create invalid SSH key
  community.digitalocean.digital_ocean_sshkey:
    name: "{{ invalid_key_name }}"
    ssh_pub_key: "{{ invalid_ssh_pub_key }}"
    oauth_token: "{{ do_api_key }}"
  ignore_errors: true
  register: result

- name: Verify that invalid SSH key failed
  ansible.builtin.assert:
    that:
      - result.failed

- name: Create SSH key
  community.digitalocean.digital_ocean_sshkey:
    name: "{{ key_name }}"
    ssh_pub_key: "{{ dummy_ssh_pub_key }}"
    oauth_token: "{{ do_api_key }}"
  register: result

- name: Verify that SSH key was created
  ansible.builtin.assert:
    that:
      - result.changed

- name: Delete SSH key
  community.digitalocean.digital_ocean_sshkey:
    state: "absent"
    fingerprint: "{{ result.data.ssh_key.fingerprint }}"
    oauth_token: "{{ do_api_key }}"
  register: result

- name: Verify that SSH key was deleted
  ansible.builtin.assert:
    that:
      - result.changed
