name: pull-request-integration

on:
  pull_request_target:
    branches: [ main ]

env:
  NAMESPACE: community
  COLLECTION_NAME: digitalocean

concurrency:
  group: cloud-integration-tests
  cancel-in-progress: false

jobs:

  integration:
    # Require reviewers for this environment
    environment: integration

    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ansible_collections/${{env.NAMESPACE}}/${{env.COLLECTION_NAME}}

    steps:

      # https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
      - name: Check out code
        uses: actions/checkout@v2
        with:
          path: ansible_collections/${{env.NAMESPACE}}/${{env.COLLECTION_NAME}}
          ref: ${{ github.event.pull_request.head.sha }} # Check out the pull request
          persist-credentials: false

      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install Ansible
        run: pip install ansible

      - name: Install ansible_collections.community.general
        run: ansible-galaxy collection install community.general -p ../../

      - name: Configure integration test run secrets
        env:
          DO_API_KEY: ${{ secrets.DO_API_KEY }}
        run: |
          ./tests/utils/render.sh \
            ./tests/integration/integration_config.yml.template \
              > ./tests/integration/integration_config.yml

      # Run the integration tests
      - name: Run integration test
        run: ansible-test integration -v --color --retry-on-error --continue-on-error --diff --python 3.8 --docker --coverage

      # ansible-test support producing code coverage date
      - name: Generate coverage report
        run: ansible-test coverage xml -v --requirements --group-by command --group-by version

      # See the reports at https://app.codecov.io/gh/ansible-collections/community.digitalocean
      - uses: codecov/codecov-action@v1
        with:
          fail_ci_if_error: false
