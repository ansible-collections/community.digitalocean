name: integration

on:
  push:
    branches:
      - ci
    # paths:
    #   - plugins/module_utils/**
    #   - plugins/modules/**

concurrency:
  group: ci-cloud-integration-tests
  cancel-in-progress: false

jobs:

  changed-files:
    runs-on: ubuntu-latest
    steps:

      - name: Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v21
        with:
          files: plugins/modules/**

      - id: set-matrix
        run: echo "::set-output name=matrix::$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | jq -R -s -c 'split(" ")')"

    outputs:
      changed-files: ${{ steps.changed-files.outputs.all_changed_files }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}

  test-job:
    runs-on: ubuntu-latest
    needs: changed-files
    steps:

      - name: Debugging
        run: |
          echo "${{ needs.changed-files.outputs.changed-files }}"
          echo "${{ needs.changed-files.outputs.matrix }}"

  integration-module:
    runs-on: ubuntu-latest
    needs: changed-files
    strategy:
      matrix:
        module: ${{ fromJson(needs.changed-files.outputs.matrix) }}
      max-parallel: 1
    steps:

      - name: Debugging
        run: |
          echo "${{ needs.changed-files.outputs.matrix }}"

      - name: Perform module testing
        if: ${{ needs.changed-files.outputs.matrix == '[""]' }}
        run: |
          echo "Got here 1"
          echo ${{ matrix.module }}

      - name: Perform module testing
        if: ${{ needs.changed-files.outputs.matrix != '[""]' }}
        run: |
          echo "Got here 2"
          echo ${{ matrix.module }}

        # uses: ansible-community/ansible-test-gh-action@unstable/v1
        # with:
        #   ansible-core-version: stable-2.11
        #   target: ${{ matrix.module }}
        #   pre-test-cmd: >-  # Configure integration test run
        #     DO_API_KEY=${{ secrets.DO_API_KEY }}
        #     AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
        #     AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
        #     ./tests/utils/render.sh
        #     tests/integration/integration_config.yml.template
        #     > tests/integration/integration_config.yml
        #   python-version: 3.9
        #   target-python-version: 3.9
        #   testing-type: integration
        #   test-deps: community.general
